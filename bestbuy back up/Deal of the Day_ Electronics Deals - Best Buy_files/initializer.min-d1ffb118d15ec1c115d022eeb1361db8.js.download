var initializer=function(libActionLog,libConfigService,redux){"use strict";var LOG="LOG",ERROR="ERROR";function log(e,t,n,i,o,r,a){return{type:LOG,level:e,message:t,error:n,componentId:o,creatorNamespace:i,contractVersion:r,instanceId:a}}var validateComponentDescriptor=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t="Invalid componentDescriptor:",n=e.creatorNamespace,i=e.componentId,o=e.contractVersion;if(!n)throw new Error(t+" must include creatorNamespace");if(!i)throw new Error(t+" must include componentId");if(!o)throw new Error(t+" must include contractVersion")},serializeComponentDescriptor=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return[e.creatorNamespace,e.componentId,e.contractVersion].join(".")},observeStore=function(t,n,i){var o=void 0;function e(){var e=n(t.getState());e!==o&&i(o=e)}var r=t.subscribe(e);return e(),r},id=function(){return Math.random().toString(36).substr(2,9)},COMPONENT_LOADING="COMPONENT_LOADING",REGISTER_COMPONENT="REGISTER_COMPONENT",componentLoading=function(e){if(!e)throw new Error("Must include all of the following: componentDescriptor");validateComponentDescriptor(e,COMPONENT_LOADING);var t=serializeComponentDescriptor(e);return{type:COMPONENT_LOADING,componentFqn:t,isLoading:!0}},registerComponent=function(e,t,n){if(!e||!t||!n)throw new Error("Must include all of the following: initStore, deInitStore, componentDescriptor, init, deinit");validateComponentDescriptor(t,REGISTER_COMPONENT);var i=serializeComponentDescriptor(t),o=id();return e[o]=n,{type:REGISTER_COMPONENT,componentFqn:i,isLoading:!1,isLoaded:!0,initFnId:o}},REGISTER_INSTANCE="REGISTER_INSTANCE",INITIALIZED_INSTANCE="INITIALIZED_INSTANCE",REGISTER_INSTANCE_DEINITFN="REGISTER_INSTANCE_DEINITFN",registerInstance=function(e,t,n){if(!e||!t||!n)throw new Error("Must include all of the following: componentDescriptor, instanceId, elementSelector");validateComponentDescriptor(e,REGISTER_INSTANCE);var i=serializeComponentDescriptor(e);return{type:REGISTER_INSTANCE,componentFqn:i,instanceId:t,elementSelector:n}},initializedInstance=function(e){return{type:INITIALIZED_INSTANCE,instanceId:e,isInitialized:!0}},registerInstanceDeInitFn=function(e,t,n){if("function"!=typeof n)throw new Error("deInitFn must be type: Function");var i=id();return e[i]=n,{type:REGISTER_INSTANCE_DEINITFN,instanceId:t,deInitFnId:i}},getComponent=function(e,t){return e.components[serializeComponentDescriptor(t)]},getInitFn=function(e,t,n){var i=getComponent(e,n);if(i)return t[i.initFnId]},isComponentLoading=function(e,t){var n=getComponent(e,t);if(n)return n&&!0===n.isLoading},isComponentLoaded=function(e,t){var n=getComponent(e,t);return!(!n||!0!==n.isLoaded)},getInstance=function(e,t){return e.instances[t]},getDeInitFnByInstanceId=function(e,t,n){var i=getInstance(e,n);if(i)return t[i.deInitFnId]},getInstanceElementSelector=function(e,t){var n=getInstance(e,t);if(n)return n.elementSelector},isInstanceInitialized=function(e,t){var n=getInstance(e,t);return!(!n||!0!==n.isInitialized)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}}(),_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e},objectWithoutProperties=function(e,t){var n={};for(var i in e)0<=t.indexOf(i)||Object.prototype.hasOwnProperty.call(e,i)&&(n[i]=e[i]);return n},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},Initializer=function(){function Initializer(e){classCallCheck(this,Initializer),this.store=e,this.initStore={},this.deInitStore={},this.initializedComponentList=[],this.initializedWithoutRegister={}}return createClass(Initializer,[{key:"log",value:function(e,t,n,i,o){var r=i.creatorNamespace,a=i.componentId,s=i.contractVersion;libActionLog.dispatch(log(e,t,n,r,a,s,o),"gvp-initializer")}},{key:"initializeComponent",value:function initializeComponent(){var componentDescriptor=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},instanceId=arguments[1],_this=this,state=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},locale=arguments[3];if("string"!=typeof locale){var err=new Error("Locale must be a string");this.logInitFailed(err,componentDescriptor,instanceId)}var _store=this.store,dispatch=_store.dispatch,getState=_store.getState,creatorNamespace=componentDescriptor.creatorNamespace,componentId=componentDescriptor.componentId,elementSelector="#"+instanceId+" ."+creatorNamespace+"-"+componentId,initFn=getInitFn(getState(),this.initStore,componentDescriptor);"string"==typeof state&&(state=eval("("+state+")"));var initArgs=[instanceId,elementSelector,state,locale,libConfigService.getComponentConfig(creatorNamespace,componentId)];if(dispatch(registerInstance(componentDescriptor,instanceId,elementSelector)),initFn)this.doInit(componentDescriptor,instanceId,initFn,initArgs);else var unregister=observeStore(this.store,function(e){return getInitFn(e,_this.initStore,componentDescriptor)},function(e){_this.doInit(componentDescriptor,instanceId,e,initArgs),unregister()})}},{key:"deInitializeInstance",value:function(t){var e=(0,this.store.getState)(),n=getDeInitFnByInstanceId(e,this.deInitStore,t),i=getInstanceElementSelector(e,t);if(n)try{return n(i),!0}catch(e){return this.log(ERROR,"Failed to deInitialize "+t),!1}}},{key:"doInit",value:function(t,n,i,o){var r=this,a=this.store.dispatch;setTimeout(function(){try{var e=i.apply(void 0,toConsumableArray(o));a(initializedInstance(n)),"function"==typeof e&&a(registerInstanceDeInitFn(r.deInitStore,n,e))}catch(e){r.logInitFailed(e,t,n)}},0)}},{key:"logInitFailed",value:function(e,t,n){var i="Failed to initialize component";throw this.log(ERROR,i,e,t,n),new Error(i)}},{key:"registerComponent",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1];this.store.dispatch(registerComponent(this.initStore,e,t))}},{key:"onRegister",value:function(t,n){var i=observeStore(this.store,function(e){return isComponentLoaded(e,t)},function(e){!0===e&&(setTimeout(function(){n()},0),i())})}},{key:"onLoad",value:function(t,n){var i=observeStore(this.store,function(e){return isComponentLoaded(e,t)},function(e){!0===e&&(setTimeout(function(){n()},0),i())})}},{key:"onInitialize",value:function(t,n){var i=observeStore(this.store,function(e){return isInstanceInitialized(e,t)},function(e){!0===e&&(setTimeout(function(){n()},0),i())})}},{key:"componentIsLoading",value:function(e){var t=this.store,n=t.dispatch,i=t.getState;isComponentLoaded(i(),e)||n(componentLoading(e))}},{key:"isComponentLoading",value:function(e){var t=this.store.getState;return isComponentLoading(t(),e)}},{key:"isComponentRegistered",value:function(e){var t=this.store.getState;return isComponentLoaded(t(),e)}},{key:"isComponentInitialized",value:function(e){return-1<this.initializedComponentList.indexOf(e)}}]),Initializer}(),components=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],n=_extends({},t);switch(n.type){case REGISTER_COMPONENT:delete n.type;var i=n.componentFqn,o=objectWithoutProperties(n,["componentFqn"]),r={};return r[i]=_extends({},o),_extends({},e,r);case COMPONENT_LOADING:delete n.type;var a=n.componentFqn,s=objectWithoutProperties(n,["componentFqn"]),c={};return c[a]=_extends({},s),_extends({},e,c);default:return e}},instances=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=arguments[1],n=_extends({},t);switch(n.type){case REGISTER_INSTANCE:delete n.type;var i=n.instanceId,o=objectWithoutProperties(n,["instanceId"]),r={};return r[i]=_extends({},o),_extends({},e,r);case INITIALIZED_INSTANCE:delete n.type;var a=n.instanceId,s=objectWithoutProperties(n,["instanceId"]),c={};return c[a]=_extends({},s,e[a]),_extends({},e,c);case REGISTER_INSTANCE_DEINITFN:delete n.type;var u=n.instanceId,l=objectWithoutProperties(n,["instanceId"]),p={};return p[u]=_extends({},l,e[u]),_extends({},e,p);default:return e}},reducers=redux.combineReducers({components:components,instances:instances}),composeEnhancers="object"===("undefined"==typeof window?"undefined":_typeof(window))&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__({name:"@gvp/lib-initializer"}):redux.compose,store=redux.createStore(reducers,composeEnhancers()),version="0.5.0",initializer=new Initializer(store);return initializer.version=version,initializer}(actionLog,configService,Redux);
